- name: Create the sources directory
  file:
    path: "{{ lfs_root }}/sources"
    state: directory
    mode: a+wt
    owner: root
    group: root

- name: Download the sources list
  get_url:
    url: http://www.linuxfromscratch.org/lfs/view/10.0-systemd/wget-list
    dest: "{{ lfs_root }}/sources/wget-list"
    # url: http://www.linuxfromscratch.org/lfs/view/8.3-systemd/wget-list


- name: Replace URL of Download Link to Mirror of savannah.gnu.org
  replace:
    path: "{{ lfs_root }}/sources/wget-list"
    regexp: "^http://download.savannah"
    replace: "^http://download-mirror.savannah"
    backup: no


- name: Replace the broken url links in wget-list
  replace:
    path: "{{ lfs_root }}/sources/wget-list"
    regexp: "{{ item.regexp }}"
    replace: "{{ item.line }}"
    backup: "{{ item.backup }}"
  register: replace_broken_links
  with_items:
    - { regexp: "^https://prdownloads.sourceforge.net/expat/expat-2.2.9.tar.xz", line: "https://sourceforge.net/projects/expat/files/expat/2.2.9/expat-2.2.9.tar.gz", state: present, backup: no }
    - { regexp: "^http://download.savannah.gnu.org/releases/libpipeline/libpipeline-1.5.3.tar.gz", line: "https://download-mirror.savannah.gnu.org/releases/libpipeline/libpipeline-1.5.3.tar.gz", state: present, backup: no }
    - { regexp: "^http://download.savannah.gnu.org/releases/man-db/man-db-2.9.3.tar.xz", line: "https://download-mirror.savannah.gnu.org/releases/man-db/man-db-2.9.3.tar.xz", state: present, backup: no }
    - { regexp: "^https://sourceforge.net/projects/psmisc/files/psmisc/psmisc-23.3.tar.xz", line: "https://sourceforge.net/projects/psmisc/files/psmisc/psmisc-23.4.tar.xz", state: present, backup: no }
    - { regexp: "^http://download.savannah.gnu.org/releases/sysvinit/sysvinit-2.97.tar.xz", line: "https://download-mirror.savannah.gnu.org/releases/sysvinit/sysvinit-2.97.tar.xz" , state: present, backup: no }
    - { regexp: "^https://zlib.net/zlib-1.2.11.tar.xz", line: "https://www.zlib.net/fossils/zlib-1.2.11.tar.gz", state: present, backup: no }
    - { regexp: "^http://download.savannah.gnu.org/releases/acl/acl-2.2.53.tar.gz", line: "http://download-mirror.savannah.gnu.org/releases/acl/acl-2.2.53.tar.gz", state: present, backup: no }
- debug: msg={{ replace_broken_links }}

# https://sourceforge.net/projects/expat/files/expat/2.2.9/expat-2.2.9.tar.gz
# https://github.com/libexpat/libexpat/download/R_2_2_9/expat-2.2.9.tar.xz


- name: Download all files from the sources list
  get_url:
    url: "{{ item }}"
    dest: "{{ lfs_root }}/sources/{{ item.split('/')[-1] }}"
  ignore_errors: true
  with_items: "{{ lookup('file', lfs_root + '/sources/wget-list').splitlines() }}"

- name: Download the md5sums file
  get_url:
    url: http://www.linuxfromscratch.org/lfs/view/10.0-systemd/md5sums
    dest: "{{ lfs_root }}/sources/md5sums"
    # url: http://www.linuxfromscratch.org/lfs/view/8.3-systemd/md5sums


- name: Check the MD5s of the sources
  command: md5sum -c md5sums
  ignore_errors: true
  args:
    chdir: "{{ lfs_root }}/sources/"
